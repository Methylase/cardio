name: Deploy Cardio App

on:
 push:
   branches:
     - main  # Trigger on pushes to the main branch

jobs:
 deploy:
   runs-on: ubuntu-latest

   steps:
   - name: Checkout code
     uses: actions/checkout@v2

   - name: Set up PHP
     uses: shivammathur/setup-php@v2
     with:
       php-version: '8.1'  # Adjust based on your PHP version

   - name: Install dependencies
     run: composer install --no-dev --prefer-dist --no-progress

   - name: Copy files to server
     uses: appleboy/scp-action@v0.1.7
     with:
       host: ${{ secrets.SERVER_IP }}
       username: ${{ secrets.SSH_USER }}
       key: ${{ secrets.SSH_KEY }}
       source: "tests/*.txt,!tests/a.txt"
       target: "/var/www/html"

   - name: Execute remote commands
     uses: appleboy/scp-action@v0.1.7
     with:
       host: ${{ secrets.SERVER_IP }}
       username: ${{ secrets.SSH_USER }}
       key: ${{ secrets.SSH_KEY }}
       script: |
         cd /var/www/html
         php artisan migrate --force
         php artisan config:cache
